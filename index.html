<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#111111">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="FlickIt">
<meta name="description" content="Realistic Zippo lighter simulator with flame physics, smoke particles, and concert mode.">
<title>FlickIt ‚Äì Virtual Lighter</title>
<!-- PWA Manifest (inline base64) -->
<link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoiRmxpY2tJdCDigJMgVmlydHVhbCBMaWdodGVyIiwic2hvcnRfbmFtZSI6IkZsaWNrSXQiLCJzdGFydF91cmwiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMxMTExMTEiLCJ0aGVtZV9jb2xvciI6IiMxMTExMTEiLCJvcmllbnRhdGlvbiI6InBvcnRyYWl0IiwiaWNvbnMiOlt7InNyYyI6ImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjRiV3h1Y3owaWFIUjBjRG92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIQnlaWE5sY25abFFYTndaV04wVW1GMGFXODlJbmhOYVc1WlRXbHVJRzFsWlhRaUlIWnBaWGRDYjNnOUlqQWdNQ0F4TmpBZ01UWXdJajQ4Y21WamRDQjNhV1IwYUQwaU1UWXdJaUJvWldsbmFIUTlJakUyTUNJZ1ptbHNiRDBpSTBVd1JUQWlJSEpsY0c5eWRHbHZiajBpZUUxaGJpd2dkbUZ5WVhraUlEeHlaV04wSUhkcFpIUm9QU0l4TmpBaUlHaGxhV2RvZEQwaU1UWXdJaUJ6ZEhsc1pUMGliV0ZqYUc4dVpHVm1ZWFZzZERzaUlERXdNREE4TDNKbFkzUStQQzl6ZG1jKyIsInR5cGUiOiJpbWFnZS9zdmcreG1sIiwic2l6ZXMiOiIxNjB4MTYwIn1dfQ==">
<style>
  /* ===== CSS VARIABLES ===== */
  :root {
    --bg: #0a0a0a;
    --metal-light: #d4d4d4;
    --metal-mid: #8a8a8a;
    --metal-dark: #2a2a2a;
    --metal-shine: #f0f0f0;
    --gold: #c9a84c;
    --accent: #ff6a00;
    --flame-orange: #ff6a00;
    --flame-yellow: #ffcc00;
    --flame-blue: #4488ff;
    --glow: rgba(255, 150, 30, 0.6);
    --text: #e8e8e8;
    --text-dim: #777;
    --panel-bg: rgba(255,255,255,0.04);
    --radius: 18px;
    --font-display: 'Georgia', 'Times New Roman', serif;
    --font-body: 'Helvetica Neue', Helvetica, sans-serif;
  }
  /* ===== RESET & BASE ===== */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body {
    width: 100%; height: 100%;
    overflow: hidden;
    background: var(--bg);
    color: var(--text);
    font-family: var(--font-body);
    -webkit-tap-highlight-color: transparent;
    touch-action: none;
    user-select: none;
  }
  /* ===== MAIN LAYOUT ===== */
  #app {
    width: 100vw; height: 100vh;
    display: flex; flex-direction: column;
    align-items: center; justify-content: flex-start;
    position: relative; overflow: hidden;
  }
  /* Background gradient */
  #app::before {
    content: '';
    position: fixed; inset: 0;
    background: radial-gradient(ellipse at 50% 80%, rgba(255,100,0,0.06) 0%, transparent 70%),
                radial-gradient(ellipse at 50% 20%, rgba(40,40,60,0.8) 0%, transparent 80%),
                linear-gradient(180deg, #090909 0%, #0f0f0f 50%, #0a0a0a 100%);
    pointer-events: none; z-index: 0;
  }
  /* ===== TOP BAR ===== */
  #topbar {
    width: 100%; max-width: 420px;
    display: flex; align-items: center; justify-content: space-between;
    padding: 14px 20px 8px;
    position: relative; z-index: 10;
  }
  .app-title {
    font-family: var(--font-display);
    font-size: 22px; letter-spacing: 3px;
    color: var(--metal-light);
    text-shadow: 0 0 20px rgba(255,160,30,0.5);
  }
  .app-title span { color: var(--accent); }
  #stats-btn, #settings-btn, #concert-btn {
    width: 38px; height: 38px;
    border: 1.5px solid rgba(255,255,255,0.12);
    border-radius: 10px;
    background: rgba(255,255,255,0.05);
    color: var(--text-dim);
    font-size: 18px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.2s;
  }
  #stats-btn:active, #settings-btn:active, #concert-btn:active {
    background: rgba(255,255,255,0.12); transform: scale(0.92);
  }
  #concert-btn.active { color: #ff44aa; border-color: #ff44aa; box-shadow: 0 0 14px #ff44aa66; }
  /* ===== COUNTER BAR ===== */
  #counter-bar {
    width: 100%; max-width: 420px;
    display: flex; align-items: center; justify-content: center; gap: 24px;
    padding: 4px 20px 6px;
    position: relative; z-index: 10;
  }
  .counter-item { text-align: center; }
  .counter-val {
    font-size: 20px; font-weight: 700;
    color: var(--accent);
    text-shadow: 0 0 10px var(--accent);
  }
  .counter-lbl { font-size: 9px; letter-spacing: 1.5px; color: var(--text-dim); text-transform: uppercase; }
  .counter-divider { width: 1px; height: 28px; background: rgba(255,255,255,0.1); }
  /* ===== CANVAS ===== */
  #flame-canvas {
    position: absolute; top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 2; pointer-events: none;
  }
  /* ===== LIGHTER WRAPPER ===== */
  #lighter-area {
    position: relative; z-index: 5;
    display: flex; flex-direction: column; align-items: center;
    margin-top: auto; margin-bottom: 0;
    padding-bottom: 10px;
    width: 100%; max-width: 420px;
  }
  /* ===== SKIN SELECTOR ===== */
  #skin-bar {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 14px;
  }
  .skin-thumb {
    width: 44px; height: 44px;
    border-radius: 10px; cursor: pointer;
    border: 2px solid transparent;
    position: relative; overflow: hidden;
    transition: all 0.2s;
  }
  .skin-thumb.active { border-color: var(--accent); box-shadow: 0 0 12px var(--accent); }
  .skin-thumb .lock-overlay {
    position: absolute; inset: 0;
    background: rgba(0,0,0,0.55);
    display: flex; align-items: center; justify-content: center;
    font-size: 16px; color: #fff;
  }
  #skin-chrome { background: linear-gradient(135deg, #c0c0c0, #808080, #e0e0e0, #606060); }
  #skin-gold { background: linear-gradient(135deg, #c9a84c, #7a5c1e, #e8cc6a, #9a7c3a); }
  #skin-neon { background: linear-gradient(135deg, #00ffcc, #0044ff, #ff00cc, #6600ff); }
  #skin-dragon { background: linear-gradient(135deg, #8b0000, #ff4400, #2a0000, #cc2200); }
  /* ===== THE LIGHTER SVG WRAPPER ===== */
  #lighter-container {
    position: relative;
    width: 160px; height: 260px;
    cursor: pointer;
    filter: drop-shadow(0 20px 40px rgba(0,0,0,0.8));
    transition: filter 0.3s;
  }
  #lighter-container.glowing {
    filter: drop-shadow(0 20px 40px rgba(0,0,0,0.8))
            drop-shadow(0 0 30px var(--glow))
            drop-shadow(0 0 60px rgba(255,120,0,0.3));
  }
  /* ===== LIGHTER SVG ===== */
  #lighter-svg { width: 100%; height: 100%; overflow: visible; }
  /* Lid transforms */
  #lid-group {
    transform-origin: 80px 108px; /* hinge point */
    transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  #lid-group.open { transform: rotate(-105deg); }
  /* ===== FLINT WHEEL ===== */
  #wheel-area {
    position: absolute;
    right: -8px; top: 45%;
    transform: translateY(-50%);
    width: 36px; height: 36px;
    cursor: grab;
  }
  #wheel-svg { width: 100%; height: 100%; }
  .wheel-rot { transform-origin: 18px 18px; transition: transform 0.1s; }
  /* ===== INSTRUCTIONS ===== */
  #hint {
    font-size: 11px; letter-spacing: 1.5px; color: var(--text-dim);
    text-align: center; text-transform: uppercase;
    margin-top: 14px;
    transition: opacity 0.5s;
  }
  /* ===== CIGARETTE ===== */
  #cigarette-wrap {
    margin-top: 12px;
    display: flex; align-items: center; justify-content: center;
    gap: 12px;
    opacity: 0; transition: opacity 0.5s;
    pointer-events: none;
  }
  #cigarette-wrap.visible { opacity: 1; pointer-events: auto; }
  #cig-svg-wrap {
    cursor: pointer;
    filter: drop-shadow(0 0 6px rgba(255,200,100,0.3));
  }
  #cig-svg-wrap:active { transform: scale(0.97); }
  .cig-label {
    font-size: 10px; letter-spacing: 1px; color: var(--text-dim); text-transform: uppercase;
  }
  /* ===== FLAME COLOR PICKER ===== */
  #color-bar {
    display: flex; align-items: center; gap: 8px; margin-bottom: 10px;
  }
  .color-dot {
    width: 24px; height: 24px; border-radius: 50%;
    cursor: pointer; border: 2px solid transparent;
    transition: all 0.2s; position: relative;
  }
  .color-dot.active { border-color: #fff; transform: scale(1.15); }
  .color-dot .lock-mini {
    position: absolute; inset: 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px;
    background: rgba(0,0,0,0.5); border-radius: 50%;
  }
  #c-orange { background: radial-gradient(#ffcc00, #ff4400); }
  #c-blue { background: radial-gradient(#88ccff, #0044ff); }
  #c-green { background: radial-gradient(#aaff44, #006600); }
  #c-purple { background: radial-gradient(#cc44ff, #440088); }
  #c-red { background: radial-gradient(#ff8888, #cc0000); }
  /* ===== PANELS (stats, settings) ===== */
  .panel {
    position: fixed; inset: 0; z-index: 100;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(12px);
    display: none; align-items: center; justify-content: center;
    padding: 24px;
  }
  .panel.open { display: flex; }
  .panel-card {
    background: #161616;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px;
    padding: 28px 24px;
    width: 100%; max-width: 380px;
    position: relative;
  }
  .panel-title {
    font-family: var(--font-display);
    font-size: 20px; letter-spacing: 2px;
    color: var(--metal-light); margin-bottom: 20px;
    text-align: center;
  }
  .panel-close {
    position: absolute; top: 16px; right: 16px;
    width: 32px; height: 32px;
    background: rgba(255,255,255,0.08); border: none; border-radius: 8px;
    color: var(--text); font-size: 16px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }
  .stat-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  .stat-row:last-child { border-bottom: none; }
  .stat-label { font-size: 13px; color: var(--text-dim); }
  .stat-value { font-size: 18px; font-weight: 700; color: var(--accent); }
  .btn-row { display: flex; gap: 10px; margin-top: 18px; }
  .btn {
    flex: 1; padding: 12px 0; border-radius: 12px; border: none;
    font-size: 13px; font-weight: 600; cursor: pointer; letter-spacing: 0.5px;
    transition: all 0.15s;
  }
  .btn:active { transform: scale(0.96); }
  .btn-primary { background: linear-gradient(135deg, #ff6a00, #ee0979); color: #fff; }
  .btn-secondary { background: rgba(255,255,255,0.08); color: var(--text); }
  .btn-gold { background: linear-gradient(135deg, var(--gold), #7a5c1e); color: #fff; }
  /* ===== PREMIUM SKIN CARDS ===== */
  .skin-card {
    display: flex; align-items: center; gap: 14px;
    padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  .skin-preview-big {
    width: 48px; height: 48px; border-radius: 12px;
    flex-shrink: 0;
  }
  .skin-info { flex: 1; }
  .skin-name { font-size: 14px; font-weight: 600; color: var(--text); }
  .skin-price { font-size: 11px; color: var(--gold); margin-top: 2px; }
  .btn-buy { padding: 8px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; }
  /* ===== AD BANNER ===== */
  #ad-banner {
    width: 100%; max-width: 420px;
    height: 50px;
    background: rgba(255,255,255,0.03);
    border-top: 1px solid rgba(255,255,255,0.07);
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; color: rgba(255,255,255,0.2);
    letter-spacing: 1px;
    position: relative; z-index: 10;
    flex-shrink: 0;
  }
  /* ===== INTERSTITIAL AD OVERLAY ===== */
  #interstitial {
    position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.92);
    display: none; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 32px;
  }
  #interstitial.open { display: flex; }
  .ad-placeholder {
    width: 100%; max-width: 360px;
    height: 250px; border-radius: 16px;
    background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
    border: 1px solid rgba(255,255,255,0.1);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center; gap: 12px;
    margin-bottom: 20px;
  }
  .ad-placeholder .ad-icon { font-size: 48px; }
  .ad-placeholder .ad-text { font-size: 13px; color: var(--text-dim); letter-spacing: 1px; }
  #skip-ad-btn {
    background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
    color: var(--text); padding: 12px 32px; border-radius: 10px;
    font-size: 14px; cursor: pointer;
  }
  /* ===== MIC PERMISSION PROMPT ===== */
  #mic-prompt {
    position: fixed; inset: 0; z-index: 150;
    background: rgba(0,0,0,0.88);
    display: none; flex-direction: column;
    align-items: center; justify-content: center; padding: 32px;
  }
  #mic-prompt.open { display: flex; }
  .prompt-card {
    background: #161616; border: 1px solid rgba(255,255,255,0.1);
    border-radius: 20px; padding: 28px 24px;
    width: 100%; max-width: 340px; text-align: center;
  }
  .prompt-icon { font-size: 52px; margin-bottom: 14px; }
  .prompt-title { font-size: 18px; font-weight: 700; margin-bottom: 8px; }
  .prompt-body { font-size: 13px; color: var(--text-dim); line-height: 1.6; margin-bottom: 20px; }
  /* ===== TOAST ===== */
  #toast {
    position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px);
    background: rgba(30,30,30,0.95); border: 1px solid rgba(255,255,255,0.12);
    border-radius: 10px; padding: 10px 20px;
    font-size: 13px; color: var(--text);
    opacity: 0; transition: all 0.3s; z-index: 300;
    white-space: nowrap;
  }
  #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  /* ===== CONCERT MODE ===== */
  #concert-overlay {
    position: fixed; inset: 0; z-index: 1;
    pointer-events: none; opacity: 0;
    transition: opacity 0.5s;
    background: transparent;
  }
  #concert-overlay.active { opacity: 1; }
  /* ===== SHARE BUTTON ===== */
  #share-btn {
    position: fixed; bottom: 62px; right: 20px; z-index: 10;
    width: 44px; height: 44px;
    border-radius: 12px;
    background: rgba(255,255,255,0.06); border: 1.5px solid rgba(255,255,255,0.1);
    color: var(--text-dim); font-size: 18px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; transition: all 0.2s;
  }
  #share-btn:active { background: rgba(255,255,255,0.12); transform: scale(0.92); }
  /* ===== INSTALL PROMPT ===== */
  #install-banner {
    position: fixed; top: 0; left: 0; right: 0; z-index: 200;
    background: linear-gradient(90deg, #1a1a1a, #222);
    border-bottom: 1px solid rgba(255,200,0,0.2);
    padding: 12px 16px; display: none; align-items: center; gap: 12px;
  }
  #install-banner.show { display: flex; }
  .install-txt { flex: 1; font-size: 13px; color: var(--text-dim); }
  .install-txt strong { color: var(--accent); }
  #install-yes, #install-no {
    padding: 8px 14px; border-radius: 8px; font-size: 12px; cursor: pointer;
  }
  #install-yes { background: var(--accent); color: #fff; border: none; }
  #install-no { background: transparent; color: var(--text-dim); border: 1px solid rgba(255,255,255,0.1); }
  /* Spark burst */
  @keyframes sparkBurst {
    0% { transform: scale(0) rotate(0deg); opacity: 1; }
    100% { transform: scale(3) rotate(90deg); opacity: 0; }
  }
  .spark-fx {
    position: absolute; width: 30px; height: 30px;
    top: 38%; right: 2px; pointer-events: none;
    animation: sparkBurst 0.4s ease-out forwards;
    color: #ffcc00; font-size: 20px;
    display: flex; align-items: center; justify-content: center;
    z-index: 20;
  }
</style>
</head>
<body>
<!-- Concert color pulse overlay -->
<div id="concert-overlay"></div>
<!-- Main App -->
<div id="app">
  <!-- Top Bar -->
  <div id="topbar">
    <div class="app-title">Flick<span>It</span></div>
    <div style="display:flex;gap:8px">
      <button id="concert-btn" title="Concert Mode">üéµ</button>
      <button id="stats-btn" title="Stats">üìä</button>
      <button id="settings-btn" title="Settings & Skins">‚öôÔ∏è</button>
    </div>
  </div>
  <!-- Counter Bar -->
  <div id="counter-bar">
    <div class="counter-item">
      <div class="counter-val" id="cnt-today">0</div>
      <div class="counter-lbl">Today</div>
    </div>
    <div class="counter-divider"></div>
    <div class="counter-item">
      <div class="counter-val" id="cnt-total">0</div>
      <div class="counter-lbl">Total</div>
    </div>
    <div class="counter-divider"></div>
    <div class="counter-item">
      <div class="counter-val" id="cnt-streak">0</div>
      <div class="counter-lbl">Streak üî•</div>
    </div>
  </div>
  <!-- Flame Canvas (behind lighter) -->
  <canvas id="flame-canvas"></canvas>
  <!-- Lighter Area -->
  <div id="lighter-area">
    <!-- Flame Color Picker -->
    <div id="color-bar">
      <div class="color-dot active" id="c-orange" data-color="orange" title="Orange"></div>
      <div class="color-dot" id="c-blue" data-color="blue" title="Blue"></div>
      <div class="color-dot" id="c-green" data-color="green" title="Green (Premium)">
        <div class="lock-mini">üîí</div>
      </div>
      <div class="color-dot" id="c-purple" data-color="purple" title="Purple (Premium)">
        <div class="lock-mini">üîí</div>
      </div>
      <div class="color-dot" id="c-red" data-color="red" title="Red (Premium)">
        <div class="lock-mini">üîí</div>
      </div>
    </div>
    <!-- Skin Selector -->
    <div id="skin-bar">
      <div class="skin-thumb active" id="skin-chrome" data-skin="chrome" title="Chrome"></div>
      <div class="skin-thumb" id="skin-gold" data-skin="gold" title="Gold (Premium)">
        <div class="lock-overlay">üîí</div>
      </div>
      <div class="skin-thumb" id="skin-neon" data-skin="neon" title="Neon Vape (Premium)">
        <div class="lock-overlay">üîí</div>
      </div>
      <div class="skin-thumb" id="skin-dragon" data-skin="dragon" title="Dragon (Premium)">
        <div class="lock-overlay">üîí</div>
      </div>
    </div>
    <!-- The Lighter -->
    <div id="lighter-container">
      <!-- Lighter SVG -->
      <svg id="lighter-svg" viewBox="0 0 160 280" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <!-- Chrome body gradient -->
          <linearGradient id="bodyGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#2a2a2a"/>
            <stop offset="15%" stop-color="#6a6a6a"/>
            <stop offset="30%" stop-color="#d0d0d0"/>
            <stop offset="50%" stop-color="#f0f0f0"/>
            <stop offset="70%" stop-color="#c0c0c0"/>
            <stop offset="85%" stop-color="#606060"/>
            <stop offset="100%" stop-color="#2a2a2a"/>
          </linearGradient>
          <!-- Wood insert gradient -->
          <linearGradient id="woodGrad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#8B5E3C"/>
            <stop offset="30%" stop-color="#6B3F2A"/>
            <stop offset="60%" stop-color="#9B6E4A"/>
            <stop offset="100%" stop-color="#5A3022"/>
          </linearGradient>
          <!-- Lid gradient -->
          <linearGradient id="lidGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#1a1a1a"/>
            <stop offset="15%" stop-color="#505050"/>
            <stop offset="30%" stop-color="#b0b0b0"/>
            <stop offset="50%" stop-color="#e0e0e0"/>
            <stop offset="70%" stop-color="#a0a0a0"/>
            <stop offset="85%" stop-color="#484848"/>
            <stop offset="100%" stop-color="#1a1a1a"/>
          </linearGradient>
          <!-- Bottom plate -->
          <linearGradient id="botGrad" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#555"/>
            <stop offset="100%" stop-color="#1a1a1a"/>
          </linearGradient>
          <!-- Hinge -->
          <linearGradient id="hingeGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#333"/>
            <stop offset="50%" stop-color="#aaa"/>
            <stop offset="100%" stop-color="#333"/>
          </linearGradient>
          <!-- Inner lid -->
          <linearGradient id="innerLidGrad" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="#888"/>
            <stop offset="100%" stop-color="#444"/>
          </linearGradient>
          <!-- Flame tube -->
          <linearGradient id="tubeGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#333"/>
            <stop offset="50%" stop-color="#999"/>
            <stop offset="100%" stop-color="#333"/>
          </linearGradient>
          <!-- Body engraving pattern -->
          <pattern id="engrave" x="0" y="0" width="10" height="10" patternUnits="userSpaceOnUse">
            <line x1="0" y1="5" x2="10" y2="5" stroke="rgba(0,0,0,0.15)" stroke-width="0.5"/>
          </pattern>
          <!-- Highlight -->
          <linearGradient id="shineLine" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" stop-color="rgba(255,255,255,0.6)"/>
            <stop offset="100%" stop-color="rgba(255,255,255,0)"/>
          </linearGradient>
        </defs>
        <!-- === BODY === -->
        <!-- Main body -->
        <rect id="body-rect" x="20" y="108" width="120" height="156" rx="6" fill="url(#bodyGrad)"/>
        <!-- Engraving lines overlay -->
        <rect x="20" y="108" width="120" height="156" rx="6" fill="url(#engrave)" opacity="0.6"/>
        <!-- Left edge shadow -->
        <rect x="20" y="108" width="8" height="156" rx="3" fill="rgba(0,0,0,0.3)"/>
        <!-- Right edge shadow -->
        <rect x="132" y="108" width="8" height="156" rx="3" fill="rgba(0,0,0,0.3)"/>
        <!-- Highlight shine line -->
        <rect x="36" y="112" width="3" height="148" rx="1.5" fill="url(#shineLine)" opacity="0.8"/>
        <!-- Wood insert panel -->
        <rect x="32" y="130" width="96" height="100" rx="3" fill="url(#woodGrad)"/>
        <!-- Wood grain lines -->
        <line x1="32" y1="145" x2="128" y2="145" stroke="rgba(0,0,0,0.2)" stroke-width="1"/>
        <line x1="32" y1="155" x2="128" y2="155" stroke="rgba(0,0,0,0.15)" stroke-width="0.5"/>
        <line x1="32" y1="165" x2="128" y2="165" stroke="rgba(0,0,0,0.2)" stroke-width="1"/>
        <line x1="32" y1="178" x2="128" y2="178" stroke="rgba(0,0,0,0.12)" stroke-width="0.5"/>
        <line x1="32" y1="190" x2="128" y2="190" stroke="rgba(0,0,0,0.2)" stroke-width="1"/>
        <line x1="32" y1="203" x2="128" y2="203" stroke="rgba(0,0,0,0.12)" stroke-width="0.5"/>
        <line x1="32" y1="215" x2="128" y2="215" stroke="rgba(0,0,0,0.2)" stroke-width="1"/>
        <!-- Wood border shadow -->
        <rect x="32" y="130" width="96" height="100" rx="3" fill="none" stroke="rgba(0,0,0,0.4)" stroke-width="1.5"/>
        <!-- FlickIt engraving text -->
        <text x="80" y="183" text-anchor="middle" font-family="Georgia, serif" font-size="11" fill="rgba(255,210,150,0.7)" letter-spacing="2">FLICKIT</text>
        <!-- Bottom body plate -->
        <rect x="22" y="258" width="116" height="8" rx="4" fill="url(#botGrad)"/>
        <!-- Bottom screws -->
        <circle cx="34" cy="262" r="3" fill="#222"/>
        <circle cx="34" cy="262" r="1.5" fill="#555"/>
        <circle cx="126" cy="262" r="3" fill="#222"/>
        <circle cx="126" cy="262" r="1.5" fill="#555"/>
        <!-- Hinge bar -->
        <rect x="72" y="105" width="16" height="8" rx="2" fill="url(#hingeGrad)"/>
        <rect x="74" y="106" width="12" height="6" rx="1" fill="rgba(255,255,255,0.15)"/>
        <!-- === CHIMNEY (always visible) === -->
        <rect id="chimney" x="50" y="88" width="60" height="24" rx="4" fill="url(#tubeGrad)"/>
        <rect x="52" y="90" width="56" height="20" rx="3" fill="rgba(0,0,0,0.5)"/>
        <rect x="54" y="92" width="52" height="16" rx="2" fill="#111"/>
        <!-- Chimney top holes -->
        <ellipse cx="80" cy="92" rx="16" ry="3" fill="#0a0a0a"/>
        <!-- Chimney shine -->
        <rect x="56" y="93" width="4" height="14" rx="2" fill="rgba(255,255,255,0.12)"/>
        <!-- === LID GROUP === -->
        <g id="lid-group">
          <!-- Lid body -->
          <rect x="20" y="18" width="120" height="92" rx="6" fill="url(#lidGrad)"/>
          <!-- Lid engraving -->
          <rect x="20" y="18" width="120" height="92" rx="6" fill="url(#engrave)" opacity="0.5"/>
          <!-- Lid left edge -->
          <rect x="20" y="18" width="8" height="92" rx="3" fill="rgba(0,0,0,0.25)"/>
          <!-- Lid right edge -->
          <rect x="132" y="18" width="8" height="92" rx="3" fill="rgba(0,0,0,0.25)"/>
          <!-- Lid shine -->
          <rect x="36" y="22" width="3" height="84" rx="1.5" fill="url(#shineLine)" opacity="0.7"/>
          <!-- Lid inner bottom (visible when open) -->
          <rect id="inner-lid" x="22" y="97" width="116" height="12" rx="2" fill="url(#innerLidGrad)" opacity="0"/>
          <!-- Lid top curve -->
          <ellipse cx="80" cy="18" rx="60" ry="8" fill="url(#lidGrad)"/>
          <ellipse cx="80" cy="18" rx="58" ry="6" fill="rgba(255,255,255,0.08)"/>
          <!-- Lid top shine dot -->
          <ellipse cx="60" cy="16" rx="12" ry="4" fill="rgba(255,255,255,0.2)"/>
          <!-- Brand mark on lid -->
          <rect x="55" y="50" width="50" height="30" rx="3" fill="rgba(0,0,0,0.2)"/>
          <text x="80" y="64" text-anchor="middle" font-family="Georgia,serif" font-size="8" fill="rgba(255,255,255,0.5)" letter-spacing="3">ZIPPO</text>
          <text x="80" y="74" text-anchor="middle" font-family="Georgia,serif" font-size="6" fill="rgba(255,255,255,0.3)" letter-spacing="1">EST. 1932</text>
        </g>
        <!-- === FLINT WHEEL === -->
        <g id="wheel-group" transform="translate(118, 108)">
          <!-- Wheel housing -->
          <rect x="0" y="0" width="22" height="22" rx="4" fill="#1a1a1a" stroke="#555" stroke-width="1"/>
          <!-- Wheel -->
          <g id="wheel-spin" transform="translate(11,11)">
            <circle r="9" fill="none" stroke="#666" stroke-width="2"/>
            <line x1="-9" y1="0" x2="9" y2="0" stroke="#888" stroke-width="1.5"/>
            <line x1="0" y1="-9" x2="0" y2="9" stroke="#888" stroke-width="1.5"/>
            <line x1="-6.4" y1="-6.4" x2="6.4" y2="6.4" stroke="#777" stroke-width="1"/>
            <line x1="6.4" y1="-6.4" x2="-6.4" y2="6.4" stroke="#777" stroke-width="1"/>
            <circle r="3" fill="#555"/>
            <circle r="1.5" fill="#999"/>
          </g>
        </g>
      </svg>
    </div>
    <!-- Cigarette Row -->
    <div id="cigarette-wrap">
      <div id="cig-svg-wrap">
        <svg id="cig-svg" width="180" height="36" viewBox="0 0 180 36">
          <defs>
            <linearGradient id="cigPaperGrad" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#f0ede5"/>
              <stop offset="50%" stop-color="#e8e4d8"/>
              <stop offset="100%" stop-color="#d0ccc0"/>
            </linearGradient>
            <linearGradient id="filterGrad" x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stop-color="#c87941"/>
              <stop offset="50%" stop-color="#9a5c2e"/>
              <stop offset="100%" stop-color="#7a3c18"/>
            </linearGradient>
          </defs>
          <!-- Cigarette body (paper) -->
          <rect x="10" y="10" width="130" height="16" rx="8" fill="url(#cigPaperGrad)"/>
          <!-- Paper seam line -->
          <line x1="10" y1="18" x2="140" y2="18" stroke="rgba(0,0,0,0.08)" stroke-width="0.5"/>
          <!-- Filter -->
          <rect x="140" y="10" width="30" height="16" rx="4" fill="url(#filterGrad)"/>
          <!-- Filter band -->
          <rect x="138" y="10" width="4" height="16" rx="1" fill="#b8733a" opacity="0.8"/>
          <!-- Lit tip glow -->
          <circle id="cig-tip" cx="13" cy="18" r="7" fill="#ff4400" opacity="0.8"/>
          <circle cx="13" cy="18" r="4" fill="#ff8800"/>
          <circle cx="13" cy="18" r="2" fill="#ffcc00"/>
          <!-- Ash -->
          <rect id="cig-ash" x="3" y="13" width="8" height="10" rx="4" fill="#888" opacity="0.6"/>
        </svg>
      </div>
      <span class="cig-label">Hold to puff</span>
    </div>
    <!-- Hint text -->
    <div id="hint">Swipe up to open ¬∑ Flick wheel to light</div>
  </div><!-- /lighter-area -->
  <!-- Ad Banner -->
  <div id="ad-banner">üì¢ AdMob Banner Here ‚Äî 320√ó50</div>
</div><!-- /app -->
<!-- Share Button -->
<button id="share-btn" title="Share">üì§</button>
<!-- Toast -->
<div id="toast"></div>
<!-- ===== STATS PANEL ===== -->
<div id="stats-panel" class="panel">
  <div class="panel-card">
    <div class="panel-title">‚ö° STATS</div>
    <button class="panel-close" id="close-stats">‚úï</button>
    <div class="stat-row"><span class="stat-label">Lit Today</span><span class="stat-value" id="sp-today">0</span></div>
    <div class="stat-row"><span class="stat-label">All Time</span><span class="stat-value" id="sp-total">0</span></div>
    <div class="stat-row"><span class="stat-label">Longest Streak</span><span class="stat-value" id="sp-streak">0 üî•</span></div>
    <div class="stat-row"><span class="stat-label">Puffs</span><span class="stat-value" id="sp-puffs">0</span></div>
    <div class="stat-row"><span class="stat-label">Concert Sessions</span><span class="stat-value" id="sp-concert">0</span></div>
    <div class="btn-row">
      <button class="btn btn-secondary" id="reset-stats-btn">Reset Stats</button>
      <button class="btn btn-primary" onclick="alert('Coming soon! Remove Ads Forever ‚Äì $2.99')">No Ads ‚Äì $2.99</button>
    </div>
  </div>
</div>
<!-- ===== SETTINGS / SKINS PANEL ===== -->
<div id="settings-panel" class="panel">
  <div class="panel-card">
    <div class="panel-title">üé® SKINS & SETTINGS</div>
    <button class="panel-close" id="close-settings">‚úï</button>
    <div class="skin-card">
      <div class="skin-preview-big" style="background:linear-gradient(135deg,#c0c0c0,#808080,#e0e0e0,#606060)"></div>
      <div class="skin-info">
        <div class="skin-name">Classic Chrome</div>
        <div class="skin-price" style="color:#aaa">Free ¬∑ Equipped</div>
      </div>
    </div>
    <div class="skin-card">
      <div class="skin-preview-big" style="background:linear-gradient(135deg,#c9a84c,#7a5c1e,#e8cc6a,#9a7c3a)"></div>
      <div class="skin-info">
        <div class="skin-name">Gold Engraved</div>
        <div class="skin-price">$1.99 Premium</div>
      </div>
      <button class="btn btn-gold btn-buy" onclick="alert('Gold Engraved Skin ‚Äì Coming soon for $1.99!')">Buy</button>
    </div>
    <div class="skin-card">
      <div class="skin-preview-big" style="background:linear-gradient(135deg,#00ffcc,#0044ff,#ff00cc,#6600ff)"></div>
      <div class="skin-info">
        <div class="skin-name">Neon Vape</div>
        <div class="skin-price">$1.99 Premium</div>
      </div>
      <button class="btn btn-primary btn-buy" onclick="alert('Neon Vape Skin ‚Äì Coming soon for $1.99!')">Buy</button>
    </div>
    <div class="skin-card">
      <div class="skin-preview-big" style="background:linear-gradient(135deg,#8b0000,#ff4400,#2a0000,#cc2200)"></div>
      <div class="skin-info">
        <div class="skin-name">Fantasy Dragon</div>
        <div class="skin-price">$2.99 Premium</div>
      </div>
      <button class="btn btn-buy" style="background:linear-gradient(135deg,#8b0000,#cc2200);color:#fff" onclick="alert('Fantasy Dragon Skin ‚Äì Coming soon for $2.99!')">Buy</button>
    </div>
    <div class="btn-row" style="margin-top:14px">
      <button class="btn btn-secondary" id="mic-toggle-btn">üé§ Blow Detection: OFF</button>
    </div>
    <div class="btn-row">
      <button class="btn btn-secondary" onclick="alert('Coming soon! Remove Ads Forever ‚Äì $2.99')">üö´ Remove Ads ‚Äì $2.99</button>
    </div>
  </div>
</div>
<!-- ===== MIC PERMISSION PROMPT ===== -->
<div id="mic-prompt">
  <div class="prompt-card">
    <div class="prompt-icon">üé§</div>
    <div class="prompt-title">Blow to Puff</div>
    <div class="prompt-body">FlickIt can detect when you blow into your phone's microphone to make the flame dance and speed up smoke. Allow microphone access?</div>
    <div class="btn-row">
      <button class="btn btn-secondary" id="mic-deny">No Thanks</button>
      <button class="btn btn-primary" id="mic-allow">Allow üî•</button>
    </div>
  </div>
</div>
<!-- ===== INTERSTITIAL AD ===== -->
<div id="interstitial">
  <div class="ad-placeholder">
    <div class="ad-icon">üì±</div>
    <div class="ad-text">INTERSTITIAL AD SLOT</div>
    <div class="ad-text" style="font-size:11px;margin-top:4px">Replace with AdMob / Google Ads</div>
  </div>
  <button id="skip-ad-btn">Skip Ad ‚Ä∫</button>
</div>
<!-- ===== INSTALL BANNER ===== -->
<div id="install-banner">
  <span class="install-txt">Add <strong>FlickIt</strong> to your home screen!</span>
  <button id="install-yes">Install</button>
  <button id="install-no">‚úï</button>
</div>
<!-- ===== SERVICE WORKER SCRIPT ===== -->
<script>
// Register inline service worker for offline support
if ('serviceWorker' in navigator) {
  const SW_CODE = `
    const CACHE = 'flickit-v1';
    self.addEventListener('install', e => {
      e.waitUntil(caches.open(CACHE).then(c => c.add('/')));
    });
    self.addEventListener('fetch', e => {
      e.respondWith(
        caches.match(e.request).then(r => r || fetch(e.request))
      );
    });
  `;
  const blob = new Blob([SW_CODE], {type: 'application/javascript'});
  const swUrl = URL.createObjectURL(blob);
  navigator.serviceWorker.register(swUrl).catch(()=>{});
}
</script>
<!-- ===== MAIN APP SCRIPT ===== -->
<script>
(function() {
  'use strict';

  // ========================
  // STATE
  // ========================
  const state = {
    isOpen: false,
    isLit: false,
    flameColor: 'orange',
    skin: 'chrome',
    concertMode: false,
    micEnabled: false,
    micAsked: false,
    wheelAngle: 0,
    litToday: 0,
    litTotal: 0,
    litStreak: 0,
    puffCount: 0,
    concertCount: 0,
    tiltX: 0,
    tiltY: 0,
    micVolume: 0,
    lastLitDate: '',
    interstitialCounter: 0,
    isPuffing: false,
  };

  function loadStats() {
    try {
      const d = JSON.parse(localStorage.getItem('flickit_stats') || '{}');
      state.litTotal = d.litTotal || 0;
      state.puffCount = d.puffCount || 0;
      state.concertCount = d.concertCount || 0;
      state.litStreak = d.litStreak || 0;
      state.lastLitDate = d.lastLitDate || '';
      const today = new Date().toDateString();
      state.litToday = (d.lastLitDate === today) ? (d.litToday || 0) : 0;
    } catch(e) {}
  }

  function saveStats() {
    try {
      const today = new Date().toDateString();
      localStorage.setItem('flickit_stats', JSON.stringify({
        litTotal: state.litTotal,
        litToday: state.litToday,
        puffCount: state.puffCount,
        concertCount: state.concertCount,
        litStreak: state.litStreak,
        lastLitDate: today,
      }));
    } catch(e) {}
  }

  function updateCounterUI() {
    document.getElementById('cnt-today').textContent = state.litToday;
    document.getElementById('cnt-total').textContent = state.litTotal;
    document.getElementById('cnt-streak').textContent = state.litStreak;
    document.getElementById('sp-today').textContent = state.litToday;
    document.getElementById('sp-total').textContent = state.litTotal;
    document.getElementById('sp-streak').textContent = state.litStreak + ' üî•';
    document.getElementById('sp-puffs').textContent = state.puffCount;
    document.getElementById('sp-concert').textContent = state.concertCount;
  }

  loadStats();
  updateCounterUI();

  // ========================
  // AUDIO
  // ========================
  let audioCtx = null;
  function getAudioCtx() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    return audioCtx;
  }

  function playClick() {
    try {
      const ctx = getAudioCtx();
      const buf = ctx.createBuffer(1, ctx.sampleRate * 0.08, ctx.sampleRate);
      const d = buf.getChannelData(0);
      for (let i = 0; i < d.length; i++) {
        d[i] = (Math.random() * 2 - 1) * Math.exp(-i / (ctx.sampleRate * 0.015));
      }
      const src = ctx.createBufferSource();
      const gain = ctx.createGain();
      gain.gain.value = 0.6;
      src.buffer = buf;
      src.connect(gain); gain.connect(ctx.destination);
      src.start();
    } catch(e) {}
  }

  function playSpark() {
    try {
      const ctx = getAudioCtx();
      const dur = 0.12;
      const buf = ctx.createBuffer(1, ctx.sampleRate * dur, ctx.sampleRate);
      const d = buf.getChannelData(0);
      for (let i = 0; i < d.length; i++) {
        const t = i / ctx.sampleRate;
        d[i] = (Math.random() * 2 - 1) * Math.exp(-t * 30) + Math.sin(2*Math.PI*3000*t) * Math.exp(-t * 50) * 0.3;
      }
      const src = ctx.createBufferSource();
      const gain = ctx.createGain(); gain.gain.value = 0.5;
      src.buffer = buf; src.connect(gain); gain.connect(ctx.destination);
      src.start();
    } catch(e) {}
  }

  function playFlame() {
    try {
      const ctx = getAudioCtx();
      const dur = 1.5;
      const buf = ctx.createBuffer(1, ctx.sampleRate * dur, ctx.sampleRate);
      const d = buf.getChannelData(0);
      for (let i = 0; i < d.length; i++) {
        d[i] = (Math.random() * 2 - 1) * 0.3;
      }
      const src = ctx.createBufferSource();
      const bpf = ctx.createBiquadFilter();
      bpf.type = 'bandpass'; bpf.frequency.value = 400; bpf.Q.value = 0.8;
      const gain = ctx.createGain();
      gain.gain.setValueAtTime(0, ctx.currentTime);
      gain.gain.linearRampToValueAtTime(0.25, ctx.currentTime + 0.1);
      gain.gain.linearRampToValueAtTime(0.15, ctx.currentTime + dur);
      src.buffer = buf;
      src.connect(bpf); bpf.connect(gain); gain.connect(ctx.destination);
      src.start();
      setTimeout(() => { try { src.stop(); } catch(e){} }, dur * 1000);
    } catch(e) {}
  }

  function playPuff() {
    try {
      const ctx = getAudioCtx();
      const dur = 0.4;
      const buf = ctx.createBuffer(1, ctx.sampleRate * dur, ctx.sampleRate);
      const d = buf.getChannelData(0);
      for (let i = 0; i < d.length; i++) {
        const t = i / ctx.sampleRate;
        d[i] = (Math.random() * 2 - 1) * Math.sin(Math.PI * t / dur) * 0.4;
      }
      const src = ctx.createBufferSource();
      const lpf = ctx.createBiquadFilter(); lpf.type = 'lowpass'; lpf.frequency.value = 800;
      const gain = ctx.createGain(); gain.gain.value = 0.4;
      src.buffer = buf; src.connect(lpf); lpf.connect(gain); gain.connect(ctx.destination);
      src.start();
    } catch(e) {}
  }

  // ========================
  // CANVAS & PARTICLES
  // ========================
  const canvas = document.getElementById('flame-canvas');
  const ctx = canvas.getContext('2d');
  let particles = [];
  let smokeParticles = [];
  let flameAlpha = 0;

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  function getFlameOrigin() {
    const lc = document.getElementById('lighter-container');
    if (!lc) return { x: window.innerWidth/2, y: window.innerHeight/2 };
    const rect = lc.getBoundingClientRect();
    return {
      x: rect.left + rect.width * 0.5,
      y: rect.top + rect.height * (88/280)
    };
  }

  function getCigTipPos() {
    const wrap = document.getElementById('cigarette-wrap');
    if (!wrap || !state.isLit) return null;
    const rect = document.getElementById('cig-svg').getBoundingClientRect();
    return {
      x: rect.left + rect.width * (13/180),
      y: rect.top + rect.height * 0.5
    };
  }

  const FLAME_COLORS = {
    orange: { base: ['#ff6a00','#ff9800','#ffcc00','#ff3300'], blue: '#4455ff', core: '#fff9e6' },
    blue: { base: ['#2244ff','#4488ff','#88ccff','#0022dd'], blue: '#001199', core: '#eeffff' },
    green: { base: ['#00aa22','#44ff44','#aaff00','#006600'], blue: '#004400', core: '#eeffcc' },
    purple: { base: ['#8800ff','#cc44ff','#ff88ff','#550099'], blue: '#330055', core: '#fff0ff' },
    red: { base: ['#cc0000','#ff2200','#ff6600','#880000'], blue: '#440000', core: '#fff5f5' },
  };

  class FlameParticle {
    constructor(ox, oy) {
      this.reset(ox, oy);
    }
    reset(ox, oy) {
      this.x = ox + (Math.random() - 0.5) * 16;
      this.y = oy;
      const intensity = 1 + state.micVolume * 2;
      this.vx = (Math.random() - 0.5) * 1.2 + state.tiltX * 0.8;
      this.vy = -(2.5 + Math.random() * 2.5) * intensity;
      this.life = 1.0;
      this.maxLife = 0.6 + Math.random() * 0.5;
      this.decay = 1.0 / (this.maxLife * 60);
      this.size = 8 + Math.random() * 18;
      const colors = FLAME_COLORS[state.flameColor];
      this.color = colors.base[Math.floor(Math.random() * colors.base.length)];
      this.isBlue = Math.random() < 0.25;
      if (this.isBlue) { this.color = colors.blue; this.size *= 0.6; }
    }
  }

  class SmokeParticle {
    constructor(ox, oy) {
      this.x = ox + (Math.random() - 0.5) * 10;
      this.y = oy;
      const speed = state.isPuffing ? (1 + state.micVolume * 3) : 0.5;
      this.vx = (Math.random() - 0.5) * 0.8 + state.tiltX * 0.3;
      this.vy = -(0.6 + Math.random() * 1.0) * speed;
      this.life = 1.0;
      this.decay = 0.005 + Math.random() * 0.006;
      this.size = 6 + Math.random() * 14;
      this.growRate = 0.15 + Math.random() * 0.2;
      this.alpha = 0.0;
      this.fadeIn = true;
    }
  }

  // ========================
  // LIGHTER LID + WHEEL
  // ========================
  const lidGroup = document.getElementById('lid-group');
  const wheelSpin = document.getElementById('wheel-spin');
  const lighterContainer = document.getElementById('lighter-container');
  const cigaretteWrap = document.getElementById('cigarette-wrap');
  const hint = document.getElementById('hint');
  let wheelAngle = 0;

  function openLid() {
    if (state.isOpen) return;
    state.isOpen = true;
    lidGroup.classList.add('open');
    playClick();
    hint.textContent = 'Drag wheel to spark ¬∑ Tap to close';
    setTimeout(() => {
      if (!state.isLit) hint.textContent = 'Flick wheel to ignite üî•';
    }, 800);
  }

  function closeLid() {
    if (!state.isOpen) return;
    state.isOpen = false;
    lidGroup.classList.remove('open');
    if (state.isLit) extinguish();
    playClick();
    hint.textContent = 'Swipe up to open ¬∑ Flick wheel to light';
  }

  function ignite() {
    if (state.isLit || !state.isOpen) return;
    state.isLit = true;
    flameAlpha = 0;
    lighterContainer.classList.add('glowing');
    playFlame();
    state.litTotal++;
    state.litToday++;
    state.litStreak = Math.max(state.litStreak + 1, state.litStreak);
    saveStats();
    updateCounterUI();
    cigaretteWrap.classList.add('visible');
    hint.textContent = 'Tilt to sway ¬∑ Blow to intensify üå¨Ô∏è';
    state.interstitialCounter++;
    if (state.interstitialCounter % 5 === 0) setTimeout(showInterstitial, 2000);
    if (!state.micAsked) {
      state.micAsked = true;
      setTimeout(() => document.getElementById('mic-prompt').classList.add('open'), 1800);
    }
  }

  function extinguish() {
    if (!state.isLit) return;
    state.isLit = false;
    flameAlpha = 0;
    lighterContainer.classList.remove('glowing');
    particles = [];
    cigaretteWrap.classList.remove('visible');
    hint.textContent = state.isOpen ? 'Flick wheel to ignite üî•' : 'Swipe up to open ¬∑ Flick wheel to light';
  }

  // FINAL FIXED TOUCH & SWIPE - ŒîŒôŒüŒ°ŒòŒ©ŒúŒïŒùŒü
  let touchStartY = null;
  let touchStartX = null;

  lighterContainer.addEventListener('touchstart', e => {
    if (e.touches.length !== 1) return;
    touchStartY = e.touches[0].clientY;
    touchStartX = e.touches[0].clientX;
    e.preventDefault();
  }, { passive: false });

  lighterContainer.addEventListener('touchmove', e => {
    if (touchStartY === null) return;
    e.preventDefault();
  }, { passive: false });

  lighterContainer.addEventListener('touchend', e => {
    if (touchStartY === null) return;

    const dy = touchStartY - e.changedTouches[0].clientY;
    const dx = Math.abs(touchStartX - e.changedTouches[0].clientX);

    // Swipe up (œÄŒπŒø ŒµœçŒ∫ŒøŒªŒø - 15 pixels threshold)
    if (dy > 15 && dx < 50) {
      if (!state.isOpen) openLid();
      else if (!state.isLit) ignite();
    }
    // Swipe down (œÄŒπŒø ŒµœçŒ∫ŒøŒªŒø Œ∫ŒªŒµŒØœÉŒπŒºŒø)
    else if (dy < -15 && dx < 50) {
      if (state.isOpen) closeLid();
    }
    // Tap (ŒºŒπŒ∫œÅŒÆ Œ∫ŒØŒΩŒ∑œÉŒ∑ ‚Üí toggle)
    else if (Math.abs(dy) < 12 && dx < 30) {
      if (!state.isOpen) openLid();
      else closeLid();
    }

    touchStartY = null;
    touchStartX = null;
  }, { passive: false });

  // Click fallback
  lighterContainer.addEventListener('click', e => {
    e.preventDefault();
    if (!state.isOpen) openLid();
    else closeLid();
  });

  // Wheel click (Œ¥ŒµŒΩ œÑŒø œÄŒµŒπœÅŒ¨ŒæŒ±ŒºŒµ)
  wheelGroup.addEventListener('click', e => {
    e.stopPropagation();
    if (!state.isOpen) { openLid(); return; }
    playSpark();
    showSparkFx();
    wheelAngle += 45;
    wheelSpin.setAttribute('transform', `translate(11,11) rotate(${wheelAngle})`);
    setTimeout(() => { if (!state.isLit) ignite(); }, 200);
  });

  function showSparkFx() {
    const sp = document.createElement('div');
    sp.className = 'spark-fx'; sp.textContent = '‚ú¶';
    lighterContainer.appendChild(sp);
    setTimeout(() => sp.remove(), 400);
  }

  // ========================
  // CIGARETTE PUFF
  // ========================
  const cigSvgWrap = document.getElementById('cig-svg-wrap');
  function startPuff() {
    if (!state.isLit) return;
    state.isPuffing = true;
    playPuff();
  }

  function stopPuff() {
    state.isPuffing = false;
    state.puffCount++;
    saveStats();
    updateCounterUI();
  }

  cigSvgWrap.addEventListener('touchstart', e => { e.preventDefault(); startPuff(); }, { passive: false });
  cigSvgWrap.addEventListener('touchend', stopPuff);
  cigSvgWrap.addEventListener('mousedown', startPuff);
  document.addEventListener('mouseup', stopPuff);

  // ========================
  // DEVICE MOTION & ORIENTATION
  // ========================
  let shakeThreshold = 18;
  let lastShakeTime = 0;
  let lastAccel = { x: 0, y: 0, z: 0 };

  function handleMotion(e) {
    const acc = e.accelerationIncludingGravity || e.acceleration;
    if (!acc) return;
    const delta = Math.sqrt(
      Math.pow(acc.x - lastAccel.x, 2) +
      Math.pow(acc.y - lastAccel.y, 2) +
      Math.pow(acc.z - lastAccel.z, 2)
    );
    const now = Date.now();
    if (delta > shakeThreshold && now - lastShakeTime > 800) {
      lastShakeTime = now;
      if (!state.isOpen) openLid();
      else if (!state.isLit) {
        playSpark(); showSparkFx();
        setTimeout(ignite, 200);
      }
    }
    lastAccel = { x: acc.x || 0, y: acc.y || 0, z: acc.z || 0 };
  }

  function handleOrientation(e) {
    state.tiltX = (e.gamma || 0) / 90;
    state.tiltY = ((e.beta || 0) - 45) / 90;
  }

  function requestMotionPermission() {
    if (typeof DeviceMotionEvent.requestPermission === 'function') {
      DeviceMotionEvent.requestPermission().then(perm => {
        if (perm === 'granted') {
          window.addEventListener('devicemotion', handleMotion);
          window.addEventListener('deviceorientation', handleOrientation);
        }
      }).catch(() => {});
    } else {
      window.addEventListener('devicemotion', handleMotion);
      window.addEventListener('deviceorientation', handleOrientation);
    }
  }
  requestMotionPermission();

  // ========================
  // MICROPHONE BLOW - ŒîŒôŒüŒ°ŒòŒ©ŒúŒïŒùŒü (Œ†ŒôŒü ŒïŒ•ŒëŒôŒ£ŒòŒóŒ§Œü)
  // ========================
  let micStream = null, micAnalyser = null, micData = null;
  let micRaf = null;

  function startMic() {
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(stream => {
        micStream = stream;
        const actx = getAudioCtx();
        const src = actx.createMediaStreamSource(stream);
        micAnalyser = actx.createAnalyser();
        micAnalyser.fftSize = 256;
        micData = new Uint8Array(micAnalyser.frequencyBinCount);
        src.connect(micAnalyser);
        state.micEnabled = true;
        showToast('üé§ Blow detection ON! Blow hard to test üî•');
        document.getElementById('mic-toggle-btn').textContent = 'üé§ Blow Detection: ON';

        function readMic() {
          micAnalyser.getByteFrequencyData(micData);
          let sum = 0;
          for (let i = 0; i < 60; i++) sum += micData[i]; // œÄŒµœÅŒπœÉœÉœåœÑŒµœÅŒ± bins
          const avg = sum / 60;
          state.micVolume = Math.min(avg / 70, 1.0); // œÄŒπŒø ŒµœÖŒ±ŒØœÉŒ∏Œ∑œÑŒø (Œ±œÄœå 128 ‚Üí 70)
          micRaf = requestAnimationFrame(readMic);
        }
        readMic();
      })
      .catch(() => showToast('Microphone denied'));
  }

  function stopMic() {
    if (micStream) micStream.getTracks().forEach(t => t.stop());
    if (micRaf) cancelAnimationFrame(micRaf);
    state.micEnabled = false;
    state.micVolume = 0;
    document.getElementById('mic-toggle-btn').textContent = 'üé§ Blow Detection: OFF';
  }

  document.getElementById('mic-allow').addEventListener('click', () => {
    document.getElementById('mic-prompt').classList.remove('open');
    startMic();
  });

  document.getElementById('mic-deny').addEventListener('click', () => {
    document.getElementById('mic-prompt').classList.remove('open');
  });

  document.getElementById('mic-toggle-btn').addEventListener('click', () => {
    if (state.micEnabled) stopMic();
    else {
      document.getElementById('settings-panel').classList.remove('open');
      setTimeout(() => document.getElementById('mic-prompt').classList.add('open'), 200);
    }
  });

  // ========================
  // CONCERT MODE
  // ========================
  const concertOverlay = document.getElementById('concert-overlay');
  const concertBtn = document.getElementById('concert-btn');
  let concertRaf = null;
  let concertPhase = 0;

  function startConcert() {
    state.concertMode = true;
    concertBtn.classList.add('active');
    concertOverlay.classList.add('active');
    state.concertCount++;
    saveStats();
    showToast('üéµ Concert Mode ON!');
    if (!state.isOpen) openLid();
    setTimeout(() => { if (!state.isLit) ignite(); }, 500);

    function pulseLoop() {
      concertPhase += 0.04;
      const r = Math.floor(120 + Math.sin(concertPhase * 1.3) * 60);
      const g = Math.floor(40 + Math.sin(concertPhase * 0.7 + 2) * 30);
      const b = Math.floor(80 + Math.sin(concertPhase * 1.7 + 4) * 50);
      const alpha = 0.12 + Math.abs(Math.sin(concertPhase)) * 0.1;
      concertOverlay.style.background = `rgba(${r},${g},${b},${alpha})`;
      document.documentElement.style.setProperty('--glow', `rgba(${r},${g},${b},0.7)`);
      concertRaf = requestAnimationFrame(pulseLoop);
    }
    pulseLoop();
  }

  function stopConcert() {
    state.concertMode = false;
    concertBtn.classList.remove('active');
    concertOverlay.classList.remove('active');
    concertOverlay.style.background = 'transparent';
    document.documentElement.style.setProperty('--glow', 'rgba(255, 150, 30, 0.6)');
    if (concertRaf) cancelAnimationFrame(concertRaf);
  }

  concertBtn.addEventListener('click', () => {
    if (state.concertMode) stopConcert();
    else startConcert();
  });

  // ========================
  // FLAME COLOR & SKIN
  // ========================
  const lockedColors = ['green', 'purple', 'red'];
  document.querySelectorAll('.color-dot').forEach(dot => {
    dot.addEventListener('click', () => {
      const color = dot.dataset.color;
      if (lockedColors.includes(color)) {
        alert(`${color.charAt(0).toUpperCase() + color.slice(1)} flame ‚Äì Premium!`);
        return;
      }
      document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
      dot.classList.add('active');
      state.flameColor = color;
      showToast(`Flame: ${color} üî•`);
    });
  });

  document.querySelectorAll('.skin-thumb').forEach(thumb => {
    thumb.addEventListener('click', () => {
      const skin = thumb.dataset.skin;
      if (thumb.querySelector('.lock-overlay')) {
        alert(`${skin} skin ‚Äì Premium!`);
        return;
      }
      document.querySelectorAll('.skin-thumb').forEach(t => t.classList.remove('active'));
      thumb.classList.add('active');
      state.skin = skin;
      showToast('Skin changed!');
    });
  });

  // ========================
  // PANELS & BUTTONS
  // ========================
  document.getElementById('stats-btn').addEventListener('click', () => {
    updateCounterUI();
    document.getElementById('stats-panel').classList.add('open');
  });

  document.getElementById('close-stats').addEventListener('click', () => document.getElementById('stats-panel').classList.remove('open'));

  document.getElementById('settings-btn').addEventListener('click', () => document.getElementById('settings-panel').classList.add('open'));

  document.getElementById('close-settings').addEventListener('click', () => document.getElementById('settings-panel').classList.remove('open'));

  document.getElementById('reset-stats-btn').addEventListener('click', () => {
    if (confirm('Reset stats?')) {
      state.litTotal = state.litToday = state.puffCount = state.concertCount = state.litStreak = 0;
      saveStats(); updateCounterUI();
      showToast('Stats reset!');
    }
  });

  ['stats-panel','settings-panel'].forEach(id => {
    document.getElementById(id).addEventListener('click', e => {
      if (e.target === e.currentTarget) e.currentTarget.classList.remove('open');
    });
  });

  // ========================
  // INTERSTITIAL & SHARE
  // ========================
  function showInterstitial() {
    document.getElementById('interstitial').classList.add('open');
  }

  document.getElementById('skip-ad-btn').addEventListener('click', () => document.getElementById('interstitial').classList.remove('open'));

  document.getElementById('share-btn').addEventListener('click', () => {
    if (navigator.share) {
      navigator.share({
        title: 'FlickIt ‚Äì Virtual Lighter',
        text: `üî• Lit ${state.litTotal} times! Streak: ${state.litStreak}`,
        url: window.location.href
      }).catch(()=>{});
    } else {
      showToast('Share link: ' + window.location.href);
    }
  });

  // ========================
  // INSTALL PROMPT
  // ========================
  let deferredPrompt = null;
  window.addEventListener('beforeinstallprompt', e => {
    e.preventDefault();
    deferredPrompt = e;
    document.getElementById('install-banner').classList.add('show');
  });

  document.getElementById('install-yes').addEventListener('click', () => {
    if (deferredPrompt) deferredPrompt.prompt();
    document.getElementById('install-banner').classList.remove('show');
  });

  document.getElementById('install-no').addEventListener('click', () => document.getElementById('install-banner').classList.remove('show'));

  // ========================
  // TOAST
  // ========================
  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
  }

  // ========================
  // MAIN RENDER LOOP
  // ========================
  const PARTICLE_COUNT = 60;
  const SMOKE_COUNT = 30;

  function spawnFlameParticle(ox, oy) {
    if (particles.length < PARTICLE_COUNT) {
      particles.push(new FlameParticle(ox, oy));
    } else {
      const p = particles.shift();
      p.reset(ox, oy);
      particles.push(p);
    }
  }

  function spawnSmokeParticle(ox, oy) {
    if (smokeParticles.length < SMOKE_COUNT) {
      smokeParticles.push(new SmokeParticle(ox, oy));
    }
  }

  function renderFrame() {
    requestAnimationFrame(renderFrame);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (!state.isLit && particles.length === 0 && smokeParticles.length === 0) return;

    const origin = getFlameOrigin();

    if (state.isLit) flameAlpha = Math.min(flameAlpha + 0.05, 1);
    else flameAlpha = Math.max(flameAlpha - 0.08, 0);

    if (state.isLit && flameAlpha > 0.3) {
      const rate = 3 + Math.floor(state.micVolume * 5);
      for (let i = 0; i < rate; i++) spawnFlameParticle(origin.x, origin.y);
    }

    for (let i = particles.length - 1; i >= 0; i--) {
      const p = particles[i];
      p.life -= p.decay;
      if (p.life <= 0) { particles.splice(i, 1); continue; }
      p.vx += state.tiltX * 0.15;
      p.vy *= 0.97;
      p.x += p.vx;
      p.y += p.vy;
      p.size *= 0.97;
      const alpha = p.life * flameAlpha;
      ctx.save();
      ctx.globalAlpha = alpha;
      const grad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size);
      grad.addColorStop(0, p.isBlue ? FLAME_COLORS[state.flameColor].core : p.color);
      grad.addColorStop(0.4, p.color);
      grad.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
    }

    if (flameAlpha > 0) {
      const glowCol = FLAME_COLORS[state.flameColor].base[0];
      ctx.save();
      ctx.globalAlpha = flameAlpha * 0.4;
      const ggrad = ctx.createRadialGradient(origin.x, origin.y, 0, origin.x, origin.y, 50);
      ggrad.addColorStop(0, glowCol);
      ggrad.addColorStop(1, 'rgba(0,0,0,0)');
      ctx.fillStyle = ggrad;
      ctx.beginPath();
      ctx.arc(origin.x, origin.y, 50, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
    }

    const cigPos = getCigTipPos();
    if (cigPos && (state.isPuffing || state.micVolume > 0.3)) {
      for (let i = 0; i < 2; i++) spawnSmokeParticle(cigPos.x, cigPos.y);
    }
    if (cigPos && state.isLit && Math.random() < 0.3) {
      spawnSmokeParticle(cigPos.x, cigPos.y - 5);
    }

    for (let i = smokeParticles.length - 1; i >= 0; i--) {
      const s = smokeParticles[i];
      s.life -= s.decay;
      if (s.life <= 0) { smokeParticles.splice(i, 1); continue; }
      s.vx += (Math.random() - 0.5) * 0.05 + state.tiltX * 0.05;
      s.vy *= 0.99;
      s.x += s.vx;
      s.y += s.vy;
      s.size += s.growRate;
      if (s.fadeIn && s.alpha < 0.25) s.alpha += 0.02;
      else { s.fadeIn = false; s.alpha = Math.min(s.alpha, s.life * 0.35); }
      ctx.save();
      ctx.globalAlpha = s.alpha;
      const sgrad = ctx.createRadialGradient(s.x, s.y, 0, s.x, s.y, s.size);
      sgrad.addColorStop(0, 'rgba(200,200,200,0.6)');
      sgrad.addColorStop(0.5, 'rgba(150,150,150,0.3)');
      sgrad.addColorStop(1, 'rgba(100,100,100,0)');
      ctx.fillStyle = sgrad;
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
      ctx.fill();
      ctx.restore();
    }
  }
  renderFrame();

  document.addEventListener('touchmove', e => { e.preventDefault(); }, { passive: false });

  // Keyboard shortcuts
  document.addEventListener('keydown', e => {
    if (e.code === 'Space') { e.preventDefault(); if (!state.isOpen) openLid(); else if (!state.isLit) ignite(); else closeLid(); }
    if (e.code === 'Escape') closeLid();
    if (e.code === 'KeyC') { if (state.concertMode) stopConcert(); else startConcert(); }
  });

  // Init
  hint.textContent = 'Tap or swipe up to open ¬∑ Shake to ignite üî•';
  showToast('Welcome to FlickIt! üî• Tap the lighter to begin');
})();
</script>
</body>
</html>


